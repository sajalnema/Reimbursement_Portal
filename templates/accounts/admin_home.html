{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<h2>Welcome, {{ user.username }}!</h2>
<p>You are logged in as an admin.</p>

<div class="card">
    <h3>Manage Departments</h3>
    <p><a href="{% url 'accounts:manage_departments' %}">Manage Departments</a></p>
</div>

<div class="card">
    <h3>Manage Employees</h3>
    <p><a href="{% url 'accounts:manage_employees' %}">Manage Employees</a></p>
</div>

<div class="card">
    <h3>Track All Reimbursements</h3>
    {% if reimbursements %}
        <ul>
        {% for reimbursement in reimbursements %}
            <li>
                <strong>{{ reimbursement.category }}:</strong> 
                {{ reimbursement.amount }} - 
                {{ reimbursement.status }} -
                <a href="{% url 'reimbursements:detail' reimbursement.pk %}">View Details</a> -
                {% if reimbursement.status == 'pending' %}
                    <form method="post" action="{% url 'reimbursements:approve' reimbursement.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <textarea name="manager_comments" placeholder="Add comments"></textarea>
                        <input type="hidden" name="action" value="approve">
                        <button type="submit">Approve</button>
                    </form>
                    <form method="post" action="{% url 'reimbursements:decline' reimbursement.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="decline">
                        <button type="submit">Decline</button>
                    </form>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No reimbursement requests submitted yet.</p>
    {% endif %}
</div>

<div class="card">
    <h3>Search and Assign Manager</h3>
    <form method="get" action="{% url 'accounts:admin_home' %}">
        <input type="text" name="search" placeholder="Search employees" value="{{ search_query }}">
        <button type="submit">Search</button>
    </form>
</div>

<div class="card">
    <h3>Employee Manager Assignments</h3>
    <table>
        <tr>
            <th>Username</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th>Department</th>
            <th>Manager</th>
            <th>Assign Manager</th>
        </tr>
        {% for employee in employees %}
        <tr>
            <td>{{ employee.username }}</td>
            <td>{{ employee.first_name }}</td>
            <td>{{ employee.last_name }}</td>
            <td>{{ employee.email }}</td>
            <td>
                {% if employee.department %}
                    {{ employee.department.name }} 
                {% else %}
                    No department
                {% endif %}
            </td>
            <td>
                {% if employee.manager %}
                    {{ employee.manager.username }}
                {% else %}
                    No manager assigned
                {% endif %}
            </td>
            <td>
                <form method="post" action="{% url 'accounts:assign_manager' %}">
                    {% csrf_token %}
                    <input type="hidden" name="employee_id" value="{{ employee.id }}">
                    <select name="manager_id">
                        <option value="">Select Manager</option>
                        {% for manager in managers %}
                            {% if manager.department == employee.department %}
                                <option value="{{ manager.id }}" {% if employee.manager == manager %}selected{% endif %}>
                                    {{ manager.username }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <button type="submit">Assign</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<div class="card">
    <h3>Change Employee to Manager</h3>
    <form method="post" action="{% url 'accounts:change_role' %}">
        {% csrf_token %}
        <label for="employee">Select Employee:</label>
        <select name="employee_id" id="employee">
            {% for employee in employees %}
                {% if not employee.is_manager %}
                    <option value="{{ employee.id }}">{{ employee.username }}</option>
                {% endif %}
            {% endfor %}
        </select>
        <button type="submit">Change to Manager</button>
    </form>
</div>

{% endblock %}
